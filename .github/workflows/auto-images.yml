name: 自动更新README图片

on:
  push:
    paths:
      - '*.png'
      - '*.jpg'
      - '*.gif'
  workflow_dispatch: # 允许手动点击运行

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: 生成图片列表并更新 README
        run: |
          # 创建临时文件存放图片代码
          echo "" > images_list.md
          
          # 遍历根目录下的图片文件 (png, jpg, gif)，按名称排序
          find . -maxdepth 1 -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.gif" \) | sort | while read file; do
            filename=$(basename "$file")
            
            # 写入图片 HTML 标签，设置宽度为 200px
            # 如果不需要标题，可以删掉下面这行 echo "#### $filename"
            echo "#### $filename" >> images_list.md
            echo "<img src='./$filename' width='200' alt='$filename' style='border-radius: 4px;'>" >> images_list.md
            echo -e "\n" >> images_list.md
          done
          
          # 使用 Python 脚本将生成的图片代码插入到标记位
          python3 -c "
          import sys
          import os

          readme_path = 'README.md'
          if not os.path.exists(readme_path):
              print('README.md 不存在')
              sys.exit(0)

          with open(readme_path, 'r', encoding='utf-8') as f:
              content = f.read()
          
          if os.path.exists('images_list.md'):
              with open('images_list.md', 'r', encoding='utf-8') as f:
                  new_images = f.read()
          else:
              new_images = ''
          
          start_marker = '<!-- IMAGES_START -->'
          end_marker = '<!-- IMAGES_END -->'
          
          if start_marker in content and end_marker in content:
              start_idx = content.find(start_marker) + len(start_marker)
              end_idx = content.find(end_marker)
              new_content = content[:start_idx] + '\n' + new_images + content[end_idx:]
              
              with open(readme_path, 'w', encoding='utf-8') as f:
                  f.write(new_content)
              print('README 已成功更新')
          else:
              print('未在 README.md 中找到 <!-- IMAGES_START --> 和 <!-- IMAGES_END --> 标记')
          "
          
      - name: 提交并推送更改
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add README.md
          # 只有在有变动时才提交，防止报错
          git diff --staged --quiet || (git commit -m "docs: 自动更新 README 预览图 (200px)" && git push)
