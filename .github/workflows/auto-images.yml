name: 自动处理PSD并更新README

on:
  push:
    paths:
      - '*.psd'    # 监听 PSD 变动
      - '*.png'
      - '*.jpg'
      - '*.gif'
      - 'config.txt'  # 监听配置文件变动
  workflow_dispatch:

permissions:
  contents: write

jobs:
  process-and-update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: 设置 Python 环境
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: 安装依赖
        run: pip install psd-tools Pillow

      - name: 转换 PSD 为 PNG
        run: |
          # 使用 Python 脚本批量转换根目录下的 PSD
          python3 -c "
          import os
          from psd_tools import PSDImage

          # 遍历当前目录
          for file in os.listdir('.'):
              if file.lower().endswith('.psd'):
                  png_name = os.path.splitext(file)[0] + '.png'
                  
                  # 如果 PNG 不存在，或者 PSD 比 PNG 新，则进行转换
                  if not os.path.exists(png_name) or os.path.getmtime(file) > os.path.getmtime(png_name):
                      print(f'正在转换: {file} -> {png_name} ...')
                      try:
                          psd = PSDImage.open(file)
                          # composite() 会合并所有图层生成预览图
                          psd.composite().save(png_name)
                          print(f'转换成功: {png_name}')
                      except Exception as e:
                          print(f'转换失败 {file}: {e}')
                  else:
                      print(f'跳过 (已存在且最新): {file}')
          "

      - name: 生成图片画廊并更新 README
        run: |
          # 读取配置文件
          python3 -c "
          import os
          import re

          # 默认配置
          images_per_row = 4
          image_size = 100

          # 读取配置文件
          if os.path.exists('config.txt'):
              with open('config.txt', 'r', encoding='utf-8') as f:
                  for line in f:
                      line = line.strip()
                      if line.startswith('images_per_row='):
                          try:
                              images_per_row = int(re.search(r'images_per_row=(\d+)', line).group(1))
                          except:
                              pass
                      elif line.startswith('image_size='):
                          try:
                              image_size = int(re.search(r'image_size=(\d+)', line).group(1))
                          except:
                              pass

          print(f'使用配置: 每行 {images_per_row} 个图片，图片大小 {image_size}px')

          # 生成图片列表
          with open('images_list.md', 'w', encoding='utf-8') as f:
              f.write('<table style=\"border-collapse: separate; border-spacing: 10px;\">\n')
              
              # 获取所有图片文件
              image_files = []
              for file in os.listdir('.'):
                  if file.lower().endswith(('.png', '.jpg', '.jpeg', '.gif')):
                      image_files.append(file)
              image_files.sort()
              
              # 生成表格
              for i in range(0, len(image_files), images_per_row):
                  row_files = image_files[i:i + images_per_row]
                  f.write('  <tr>\n')
                  
                  for file in row_files:
                      display_name = os.path.splitext(file)[0]
                      f.write(f'    <td style=\"text-align: center; vertical-align: top;\">\n')
                      f.write(f'      <a href=\"{file}\" target=\"_blank\">\n')
                      f.write(f'        <img src=\"{file}\" width=\"{image_size}\" alt=\"{file}\" style=\"border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\">\n')
                      f.write(f'      </a>\n')
                      f.write(f'      <p style=\"font-size: 12px; color: #666; margin-top: 5px;\">{display_name}</p>\n')
                      f.write(f'    </td>\n')
                  
                  # 如果最后一行不足，用空单元格补齐
                  if len(row_files) < images_per_row:
                      for _ in range(images_per_row - len(row_files)):
                          f.write('    <td></td>\n')
                  
                  f.write('  </tr>\n')
              
              f.write('</table>\n')

          # 更新 README 内容
          try:
              with open('README.md', 'r', encoding='utf-8') as f:
                  content = f.read()
          except:
              content = ''

          with open('images_list.md', 'r', encoding='utf-8') as f:
              new_images = f.read()

          start_marker = '<!-- IMAGES_START -->'
          end_marker = '<!-- IMAGES_END -->'

          if start_marker in content and end_marker in content:
              # 在现有标记之间插入
              start_idx = content.find(start_marker) + len(start_marker)
              end_idx = content.find(end_marker)
              new_content = content[:start_idx] + '\n' + new_images + '\n' + content[end_idx:]
          else:
              # 如果没有标记，添加到文件末尾
              new_content = content + '\n\n' + start_marker + '\n' + new_images + '\n' + end_marker + '\n'

          with open('README.md', 'w', encoding='utf-8') as f:
              f.write(new_content)
          "

      - name: 提交更改 (包括生成的PNG和README)
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          
          # 添加生成的 PNG 文件
          git add *.png
          git add README.md
          
          # 如果有变化则提交
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto convert PSD to PNG and update README" && git push)
