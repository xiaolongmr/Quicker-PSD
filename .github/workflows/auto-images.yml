name: 自动处理PSD并更新README

on:
  push:
    paths:
      - '*.psd'    
      - '*.png'
      - '*.jpg'
      - '*.gif'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  process-and-update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: 设置 Python 环境
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: 安装依赖
        run: pip install psd-tools Pillow

      - name: 转换 PSD 为 PNG
        run: |
          python3 -c "
          import os
          from psd_tools import PSDImage
          for file in os.listdir('.'):
              if file.lower().endswith('.psd'):
                  png_name = os.path.splitext(file)[0] + '.png'
                  if not os.path.exists(png_name) or os.path.getmtime(file) > os.path.getmtime(png_name):
                      print(f'正在转换: {file} -> {png_name} ...')
                      try:
                          psd = PSDImage.open(file)
                          psd.composite().save(png_name)
                          print(f'转换成功: {png_name}')
                      except Exception as e:
                          print(f'转换失败 {file}: {e}')
                  else:
                      print(f'跳过 (已存在且最新): {file}')
          "

      - name: 生成图片表格并更新 README
        run: |
          echo "" > images_list.md
          # 表格布局：每行1列（或可调整columns参数改每行多列）
          echo "<table style='border-collapse: separate; border-spacing: 10px;'>" >> images_list.md
          
          find . -maxdepth 1 -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" \) | sort | while read file; do
            filename=$(basename "$file")
            display_name="${filename%.*}"
            
            # 每个图片占一个单元格
            echo "<tr>" >> images_list.md
            echo "  <td style='text-align: center; vertical-align: top;'>" >> images_list.md
            echo "    <a href='$filename' target='_blank'>" >> images_list.md
            echo "      <img src='$filename' width='100' alt='$filename' style='border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);'>" >> images_list.md
            echo "    </a>" >> images_list.md
            echo "    <p style='font-size: 12px; color: #666; margin-top: 5px;'>$display_name</p>" >> images_list.md
            echo "  </td>" >> images_list.md
            echo "</tr>" >> images_list.md
          done
          
          echo "</table>" >> images_list.md
          
          # 更新 README 内容
          python3 -c "
          import sys
          try:
              with open('README.md', 'r', encoding='utf-8') as f: content = f.read()
          except: sys.exit(0)
          
          with open('images_list.md', 'r', encoding='utf-8') as f: new_images = f.read()
          
          start = '<!-- IMAGES_START -->'
          end = '<!-- IMAGES_END -->'
          
          if start in content and end in content:
              s_idx = content.find(start) + len(start)
              e_idx = content.find(end)
              new_content = content[:s_idx] + '\n' + new_images + '\n' + content[e_idx:]
              with open('README.md', 'w', encoding='utf-8') as f: f.write(new_content)
          "

      - name: 提交更改
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          
          git add *.png
          git add README.md
          
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto convert PSD to PNG and update README" && git push)
